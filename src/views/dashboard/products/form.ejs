<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= product ? 'Edit' : 'New' %> Product - OnlyFreds</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body class="d-flex flex-column min-vh-100 bg-light">
  <%- include("../../partials/navbar") %>

  <div class="container py-5">
    
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-7">
            
            <div class="text-center mb-4">
                <h2 class="fw-bold"><%= product ? 'Edit Product' : 'Add Product' %></h2>
                <p class="text-muted">Add a new item to the shop</p>
            </div>

            <% if (error) { %>
                <div class="alert alert-danger rounded-4 shadow-sm border-0 mb-4"><%= error %></div>
            <% } %>

            <div class="card border-0 shadow rounded-4 p-4 p-md-5">
                <form action="<%= product && product.productId ? '/dashboard/admin/products/edit/' + product.productId : '/dashboard/admin/products/new' %>" method="POST">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Product Name</label>
                        <input type="text" name="name" class="form-control rounded-3 bg-light border-0" value="<%= product ? product.name : '' %>" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Category</label>
                        <select name="categoryId" class="form-select rounded-3 bg-light border-0" required>
                            <option value="" disabled <%= !product ? 'selected' : '' %>>Select Category</option>
                            <% categories.forEach(cat => { %>
                                <option value="<%= cat.categoryId %>" <%= (product && product.categoryId === cat.categoryId) ? 'selected' : '' %>>
                                    <%= cat.name %>
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" id="hasVariants" name="hasVariants" <%= (product && product.hasVariants) ? 'checked' : '' %>>
                        <label class="form-check-label fw-bold" for="hasVariants">This product has variants</label>
                    </div>

                    <div id="simplePriceSection" class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Price (₱)</label>
                        <input type="number" step="0.01" name="price" id="mainPriceInput" class="form-control rounded-3 bg-light border-0" value="<%= product ? product.price : '' %>">
                    </div>

                    <div id="variantsSection" class="mb-4 d-none">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Product Variants</label>
                        <div id="variantsContainer" class="d-flex flex-column gap-2">
                            <% if (product && product.variants && product.variants.length > 0) { %>
                                <% product.variants.forEach((v) => { %>
                                    <div class="input-group">
                                        <input type="text" name="variantNames[]" class="form-control bg-light border-0" placeholder="Variant Name (e.g. Small)" value="<%= v.name %>" required>
                                        <input type="number" step="0.01" name="variantPrices[]" class="form-control bg-light border-0" placeholder="Price" value="<%= v.price %>" required>
                                        <button type="button" class="btn btn-outline-danger remove-variant">×</button>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                        <button type="button" id="addVariantBtn" class="btn btn-sm btn-outline-primary mt-2 rounded-pill fw-bold">+ Add Variant</button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Image URL</label>
                        <input type="text" name="imgUrl" class="form-control rounded-3 bg-light border-0" placeholder="https://... or /img/..." value="<%= product ? product.imgUrl : '' %>">
                        <div class="form-text">Link to an image of the product. Leave empty for default.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold text-secondary small text-uppercase">Description</label>
                        <textarea name="description" class="form-control rounded-3 bg-light border-0" rows="4"><%= product ? product.description : '' %></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg rounded-pill shadow-sm fw-bold">
                            <%= product && product.productId ? 'Save Changes' : 'Create Product' %>
                        </button>
                        <a href="/dashboard/admin/products" class="btn btn-light btn-lg rounded-pill text-muted fw-bold">Cancel</a>
                    </div>

                </form>
            </div>

        </div>
    </div>

  </div>

  <%- include("../../partials/footer") %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    const hasVariantsCheckbox = document.getElementById('hasVariants');
    const simplePriceSection = document.getElementById('simplePriceSection');
    const variantsSection = document.getElementById('variantsSection');
    const mainPriceInput = document.getElementById('mainPriceInput');
    const variantsContainer = document.getElementById('variantsContainer');
    const addVariantBtn = document.getElementById('addVariantBtn');

    function toggleSections() {
        if (hasVariantsCheckbox.checked) {
            simplePriceSection.classList.add('d-none');
            variantsSection.classList.remove('d-none');
            mainPriceInput.removeAttribute('required');

            if (variantsContainer.children.length === 0) {
                addVariantRow();
            }
        } else {
            simplePriceSection.classList.remove('d-none');
            variantsSection.classList.add('d-none');
            mainPriceInput.setAttribute('required', 'true');
        }
    }

    function addVariantRow() {
        const row = document.createElement('div');
        row.className = 'input-group';
        row.innerHTML = `
            <input type="text" name="variantNames[]" class="form-control bg-light border-0" placeholder="Variant Name (e.g. XL)" required>
            <input type="number" step="0.01" name="variantPrices[]" class="form-control bg-light border-0" placeholder="Price" required>
            <button type="button" class="btn btn-outline-danger remove-variant">×</button>
        `;
        variantsContainer.appendChild(row);
    }

    addVariantBtn.addEventListener('click', addVariantRow);

    variantsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-variant')) {
            e.target.parentElement.remove();
        }
    });

    hasVariantsCheckbox.addEventListener('change', toggleSections);

    toggleSections();
  </script>
</body>
</html>